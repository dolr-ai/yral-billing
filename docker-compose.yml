services:
  yral-billing:
    image: ghcr.io/dolr-ai/yral-billing:latest
    container_name: yral-billing
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      DATABASE_URL: /data/billing.db
      PORT: 3000
      APP_ENV: ${APP_ENV}
      RUST_LOG: info
      GOOGLE_SERVICE_ACCOUNT_JSON: ${GOOGLE_SERVICE_ACCOUNT_JSON}
      BACKEND_ADMIN_SECRET_KEY: ${BACKEND_ADMIN_SECRET_KEY}
    volumes:
      - ./data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - low_traffic_1

  litestream:
    image: litestream/litestream:latest
    container_name: yral-billing-litestream
    restart: unless-stopped
    environment:
      LITESTREAM_ACCESS_KEY_ID: ${LITESTREAM_ACCESS_KEY_ID}
      LITESTREAM_SECRET_ACCESS_KEY: ${LITESTREAM_SECRET_ACCESS_KEY}
      LITESTREAM_S3_ENDPOINT: fsn1.your-objectstorage.com
      LITESTREAM_S3_BUCKET: ${LITESTREAM_S3_BUCKET}
    volumes:
      - ./data:/data
      - ./litestream.yml:/etc/litestream.yml
    command: replicate
    depends_on:
      - yral-billing
    networks:
      - low_traffic_1
    healthcheck:
      test: ["CMD", "test", "-f", "/data/billing.db"]
      interval: 30s
      timeout: 10s
      retries: 3


networks:
  low_traffic_1:
    external: true